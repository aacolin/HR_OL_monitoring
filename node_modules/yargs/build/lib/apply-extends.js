"use strict";
Object.defineProperty(e***REMOVED***ports, "__esModule", { value: true });
e***REMOVED***ports.applyE***REMOVED***tends = void 0;
const fs = require("fs");
const path = require("path");
const yerror_1 = require("./yerror");
let previouslyVisitedConfigs = [];
function checkForCircularE***REMOVED***tends(cfgPath) {
    if (previouslyVisitedConfigs.inde***REMOVED***Of(cfgPath) > -1) {
        throw new yerror_1.YError(`Circular e***REMOVED***tended configurations: '${cfgPath}'.`);
    }
}
function getPathToDefaultConfig(cwd, pathToE***REMOVED***tend) {
    return path.resolve(cwd, pathToE***REMOVED***tend);
}
function mergeDeep(config1, config2) {
    const target = {};
    function isObject(obj) {
        return obj && typeof obj === 'object' && !Array.isArray(obj);
    }
    Object.assign(target, config1);
    for (const key of Object.keys(config2)) {
        if (isObject(config2[key]) && isObject(target[key])) {
            target[key] = mergeDeep(config1[key], config2[key]);
        }
        else {
            target[key] = config2[key];
        }
    }
    return target;
}
function applyE***REMOVED***tends(config, cwd, mergeE***REMOVED***tends = false) {
    let defaultConfig = {};
    if (Object.prototype.hasOwnProperty.call(config, 'e***REMOVED***tends')) {
        if (typeof config.e***REMOVED***tends !== 'string')
            return defaultConfig;
        const isPath = /\.json|\..*rc$/.test(config.e***REMOVED***tends);
        let pathToDefault = null;
        if (!isPath) {
            try {
                pathToDefault = require.resolve(config.e***REMOVED***tends);
            }
            catch (err) {
                // most likely this simply isn't a module.
            }
        }
        else {
            pathToDefault = getPathToDefaultConfig(cwd, config.e***REMOVED***tends);
        }
        // maybe the module uses key for some other reason,
        // err on side of caution.
        if (!pathToDefault && !isPath)
            return config;
        if (!pathToDefault)
            throw new yerror_1.YError(`Unable to find e***REMOVED***tended config '${config.e***REMOVED***tends}' in '${cwd}'.`);
        checkForCircularE***REMOVED***tends(pathToDefault);
        previouslyVisitedConfigs.push(pathToDefault);
        defaultConfig = isPath ? JSON.parse(fs.readFileSync(pathToDefault, 'utf8')) : require(config.e***REMOVED***tends);
        delete config.e***REMOVED***tends;
        defaultConfig = applyE***REMOVED***tends(defaultConfig, path.dirname(pathToDefault), mergeE***REMOVED***tends);
    }
    previouslyVisitedConfigs = [];
    return mergeE***REMOVED***tends ? mergeDeep(defaultConfig, config) : Object.assign({}, defaultConfig, config);
}
e***REMOVED***ports.applyE***REMOVED***tends = applyE***REMOVED***tends;
