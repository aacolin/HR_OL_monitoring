#!/usr/bin/env node

'use strict';

const fs = require('fs');
const path = require('path');
const mimeScore = require('mime-score');

let db = require('mime-db');
let chalk = require('chalk');

const STANDARD_FACET_SCORE = 900;

const byE***REMOVED***tension = {};

// Clear out any conflict e***REMOVED***tensions in mime-db
for (let type in db) {
  let entry = db[type];
  entry.type = type;

  if (!entry.e***REMOVED***tensions) continue;

  entry.e***REMOVED***tensions.forEach(e***REMOVED***t => {
    if (e***REMOVED***t in byE***REMOVED***tension) {
      const e0 = entry;
      const e1 = byE***REMOVED***tension[e***REMOVED***t];
      e0.pri = mimeScore(e0.type, e0.source);
      e1.pri = mimeScore(e1.type, e1.source);

      let drop = e0.pri < e1.pri ? e0 : e1;
      let keep = e0.pri >= e1.pri ? e0 : e1;
      drop.e***REMOVED***tensions = drop.e***REMOVED***tensions.filter(e => e !== e***REMOVED***t);

      console.log(`${e***REMOVED***t}: Keeping ${chalk.green(keep.type)} (${keep.pri}), dropping ${chalk.red(drop.type)} (${drop.pri})`);
    }
    byE***REMOVED***tension[e***REMOVED***t] = entry;
  });
}

function writeTypesFile(types, path) {
  fs.writeFileSync(path, JSON.stringify(types));
}

// Segregate into standard and non-standard types based on facet per
// https://tools.ietf.org/html/rfc6838#section-3.1
const types = {};

Object.keys(db).sort().forEach(k => {
  const entry = db[k];
  types[entry.type] = entry.e***REMOVED***tensions;
});

writeTypesFile(types, path.join(__dirname, '..', 'types.json'));
