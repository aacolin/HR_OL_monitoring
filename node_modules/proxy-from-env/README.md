# pro***REMOVED***y-from-env

[![Build Status](https://travis-ci.org/Rob--W/pro***REMOVED***y-from-env.svg?branch=master)](https://travis-ci.org/Rob--W/pro***REMOVED***y-from-env)
[![Coverage Status](https://coveralls.io/repos/github/Rob--W/pro***REMOVED***y-from-env/badge.svg?branch=master)](https://coveralls.io/github/Rob--W/pro***REMOVED***y-from-env?branch=master)

`pro***REMOVED***y-from-env` is a Node.js package that e***REMOVED***ports a function (`getPro***REMOVED***yForUrl`)
that takes an input URL (a string or
[`url.parse`](https://nodejs.org/docs/latest/api/url.html#url_url_parsing)'s
return value) and returns the desired pro***REMOVED***y URL (also a string) based on
standard pro***REMOVED***y environment variables. If no pro***REMOVED***y is set, an empty string is
returned.

It is your responsibility to actually pro***REMOVED***y the request using the given URL.

Installation:

```sh
npm install pro***REMOVED***y-from-env
```

## E***REMOVED***ample
This e***REMOVED***ample shows how the data for a URL can be fetched via the
[`http` module](https://nodejs.org/api/http.html), in a pro***REMOVED***y-aware way.

```javascript
var http = require('http');
var parseUrl = require('url').parse;
var getPro***REMOVED***yForUrl = require('pro***REMOVED***y-from-env').getPro***REMOVED***yForUrl;

var some_url = 'http://e***REMOVED***ample.com/something';

// // E***REMOVED***ample, if there is a pro***REMOVED***y server at 10.0.0.1:1234, then setting the
// // http_pro***REMOVED***y environment variable causes the request to go through a pro***REMOVED***y.
// process.env.http_pro***REMOVED***y = 'http://10.0.0.1:1234';
// 
// // But if the host to be pro***REMOVED***ied is listed in NO_PROXY, then the request is
// // not pro***REMOVED***ied (but a direct request is made).
// process.env.no_pro***REMOVED***y = 'e***REMOVED***ample.com';

var pro***REMOVED***y_url = getPro***REMOVED***yForUrl(some_url);  // <-- Our magic.
if (pro***REMOVED***y_url) {
  // Should be pro***REMOVED***ied through pro***REMOVED***y_url.
  var parsed_some_url = parseUrl(some_url);
  var parsed_pro***REMOVED***y_url = parseUrl(pro***REMOVED***y_url);
  // A HTTP pro***REMOVED***y is quite simple. It is similar to a normal request, e***REMOVED***cept the
  // path is an absolute URL, and the pro***REMOVED***ied URL's host is put in the header
  // instead of the server's actual host.
  httpOptions = {
    protocol: parsed_pro***REMOVED***y_url.protocol,
    hostname: parsed_pro***REMOVED***y_url.hostname,
    port: parsed_pro***REMOVED***y_url.port,
    path: parsed_some_url.href,
    headers: {
      Host: parsed_some_url.host,  // = host name + optional port.
    },
  };
} else {
  // Direct request.
  httpOptions = some_url;
}
http.get(httpOptions, function(res) {
  var responses = [];
  res.on('data', function(chunk) { responses.push(chunk); });
  res.on('end', function() { console.log(responses.join(''));  });
});

```

## Environment variables
The environment variables can be specified in lowercase or uppercase, with the
lowercase name having precedence over the uppercase variant. A variable that is
not set has the same meaning as a variable that is set but has no value.

### NO\_PROXY

`NO_PROXY` is a list of host names (optionally with a port). If the input URL
matches any of the entries in `NO_PROXY`, then the input URL should be fetched
by a direct request (i.e. without a pro***REMOVED***y).

Matching follows the following rules:

- `NO_PROXY=*` disables all pro***REMOVED***ies.
- Space and commas may be used to separate the entries in the `NO_PROXY` list.
- If `NO_PROXY` does not contain any entries, then pro***REMOVED***ies are never disabled.
- If a port is added after the host name, then the ports must match. If the URL
  does not have an e***REMOVED***plicit port name, the protocol's default port is used.
- Generally, the pro***REMOVED***y is only disabled if the host name is an e***REMOVED***act match for
  an entry in the `NO_PROXY` list. The only e***REMOVED***ceptions are entries that start
  with a dot or with a wildcard; then the pro***REMOVED***y is disabled if the host name
  ends with the entry.

See `test.js` for e***REMOVED***amples of what should match and what does not.

### \*\_PROXY

The environment variable used for the pro***REMOVED***y depends on the protocol of the URL.
For e***REMOVED***ample, `https://e***REMOVED***ample.com` uses the "https" protocol, and therefore the
pro***REMOVED***y to be used is `HTTPS_PROXY` (_NOT_ `HTTP_PROXY`, which is _only_ used for
http:-URLs).

The library is not limited to http(s), other schemes such as
`FTP_PROXY` (ftp:),
`WSS_PROXY` (wss:),
`WS_PROXY` (ws:)
are also supported.

If present, `ALL_PROXY` is used as fallback if there is no other match.


## E***REMOVED***ternal resources
The e***REMOVED***act way of parsing the environment variables is not codified in any
standard. This library is designed to be compatible with formats as e***REMOVED***pected by
e***REMOVED***isting software.
The following resources were used to determine the desired behavior:

- cURL:
  https://curl.ha***REMOVED******REMOVED***.se/docs/manpage.html#ENVIRONMENT  
  https://github.com/curl/curl/blob/4af40b3646d3b09f68e419f7ca866ff395d1f897/lib/url.c#L4446-L4514  
  https://github.com/curl/curl/blob/4af40b3646d3b09f68e419f7ca866ff395d1f897/lib/url.c#L4608-L4638  

- wget: 
  https://www.gnu.org/software/wget/manual/wget.html#Pro***REMOVED***ies  
  http://git.savannah.gnu.org/cgit/wget.git/tree/src/init.c?id=636a5f9a1c508aa39e35a3a8e9e54520a284d93d#n383  
  http://git.savannah.gnu.org/cgit/wget.git/tree/src/retr.c?id=93c1517c4071c4288ba5a4b038e7634e4c6b5482#n1278  

- W3:
  https://www.w3.org/Daemon/User/Pro***REMOVED***ies/Pro***REMOVED***yClients.html  

- Python's urllib:
  https://github.com/python/cpython/blob/936135bb97fe04223aa30ca6e98eac8f3ed6b349/Lib/urllib/request.py#L755-L782  
  https://github.com/python/cpython/blob/936135bb97fe04223aa30ca6e98eac8f3ed6b349/Lib/urllib/request.py#L2444-L2479
