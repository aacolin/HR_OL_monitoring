require! {
  '../library/fn/promise': Promise
  './config': {list, e***REMOVED***perimental, libraryBlacklist, es5SpecialCase, banner}
  fs: {readFile, writeFile, unlink}
  path: {basename, dirname, join}
  webpack, temp
}

module.e***REMOVED***ports = ({modules = [], blacklist = [], library = no, umd = on})->
  resolve, reject <~! new Promise _
  let @ = modules.reduce ((memo, it)-> memo[it] = on; memo), {}
    if @e***REMOVED***p => for e***REMOVED***perimental => @[..] = on
    if @es5 => for es5SpecialCase => @[..] = on
    for ns of @
      if @[ns]
        for name in list
          if name.inde***REMOVED***Of("#ns.") is 0 and name not in e***REMOVED***perimental
            @[name] = on

    if library => blacklist ++= libraryBlacklist
    for ns in blacklist
      for name in list
        if name is ns or name.inde***REMOVED***Of("#ns.") is 0
          @[name] = no

    TARGET = temp.path {suffi***REMOVED***: '.js'}

    err, info <~! webpack do
      entry: list.filter(~> @[it]).map ~>
        if library => join __dirname, '..', 'library', 'modules', it
        else join __dirname, '..', 'modules', it
      output:
        path: dirname TARGET
        filename: basename "./#TARGET"
    if err => return reject err

    err, script <~! readFile TARGET
    if err => return reject err

    err <~! unlink TARGET
    if err => return reject err

    if umd
      e***REMOVED***portScript = """
        // CommonJS e***REMOVED***port
        if (typeof module != 'undefined' && module.e***REMOVED***ports) module.e***REMOVED***ports = __e;
        // RequireJS e***REMOVED***port
        else if (typeof define == 'function' && define.amd) define(function () { return __e; });
        // E***REMOVED***port to global object
        else __g.core = __e;
        """
    else
      e***REMOVED***portScript = ""

    resolve """
      #banner
      !function(__e, __g, undefined){
      'use strict';
      #script
      #e***REMOVED***portScript
      }(1, 1);
      """