import { clearTimeout } from 'timers';

import type { Binary, Long, Timestamp } from '../bson';
import type { ClientSession } from '../sessions';
import type { Topology } from './topology';

// shared state names
e***REMOVED***port const STATE_CLOSING = 'closing';
e***REMOVED***port const STATE_CLOSED = 'closed';
e***REMOVED***port const STATE_CONNECTING = 'connecting';
e***REMOVED***port const STATE_CONNECTED = 'connected';

/**
 * An enumeration of topology types we know about
 * @public
 */
e***REMOVED***port const TopologyType = Object.freeze({
  Single: 'Single',
  ReplicaSetNoPrimary: 'ReplicaSetNoPrimary',
  ReplicaSetWithPrimary: 'ReplicaSetWithPrimary',
  Sharded: 'Sharded',
  Unknown: 'Unknown',
  LoadBalanced: 'LoadBalanced'
} as const);

/** @public */
e***REMOVED***port type TopologyType = (typeof TopologyType)[keyof typeof TopologyType];

/**
 * An enumeration of server types we know about
 * @public
 */
e***REMOVED***port const ServerType = Object.freeze({
  Standalone: 'Standalone',
  Mongos: 'Mongos',
  PossiblePrimary: 'PossiblePrimary',
  RSPrimary: 'RSPrimary',
  RSSecondary: 'RSSecondary',
  RSArbiter: 'RSArbiter',
  RSOther: 'RSOther',
  RSGhost: 'RSGhost',
  Unknown: 'Unknown',
  LoadBalancer: 'LoadBalancer'
} as const);

/** @public */
e***REMOVED***port type ServerType = (typeof ServerType)[keyof typeof ServerType];

/** @internal */
e***REMOVED***port type TimerQueue = Set<NodeJS.Timeout>;

/** @internal */
e***REMOVED***port function drainTimerQueue(queue: TimerQueue): void {
  queue.forEach(clearTimeout);
  queue.clear();
}

/**
 * @public
 * Gossiped in component for the cluster time tracking the state of user databases
 * across the cluster. It may optionally include a signature identifying the process that
 * generated such a value.
 */
e***REMOVED***port interface ClusterTime {
  clusterTime: Timestamp;
  /** Used to validate the identity of a request or response's ClusterTime. */
  signature?: {
    hash: Binary;
    keyId: Long;
  };
}

/** Shared function to determine clusterTime for a given topology or session */
e***REMOVED***port function _advanceClusterTime(
  entity: Topology | ClientSession,
  $clusterTime: ClusterTime
): void {
  if (entity.clusterTime == null) {
    entity.clusterTime = $clusterTime;
  } else {
    if ($clusterTime.clusterTime.greaterThan(entity.clusterTime.clusterTime)) {
      entity.clusterTime = $clusterTime;
    }
  }
}
