import { addFormatToken } from '../format/format';
import { addRege***REMOVED***Token, matchUnsigned, rege***REMOVED***Escape } from '../parse/rege***REMOVED***';
import { addParseToken } from '../parse/token';
import { YEAR } from './constants';
import { hooks as moment } from '../utils/hooks';
import { getLocale } from '../locale/locales';
import getParsingFlags from '../create/parsing-flags';
import hasOwnProp from '../utils/has-own-prop';

addFormatToken('N', 0, 0, 'eraAbbr');
addFormatToken('NN', 0, 0, 'eraAbbr');
addFormatToken('NNN', 0, 0, 'eraAbbr');
addFormatToken('NNNN', 0, 0, 'eraName');
addFormatToken('NNNNN', 0, 0, 'eraNarrow');

addFormatToken('y', ['y', 1], 'yo', 'eraYear');
addFormatToken('y', ['yy', 2], 0, 'eraYear');
addFormatToken('y', ['yyy', 3], 0, 'eraYear');
addFormatToken('y', ['yyyy', 4], 0, 'eraYear');

addRege***REMOVED***Token('N', matchEraAbbr);
addRege***REMOVED***Token('NN', matchEraAbbr);
addRege***REMOVED***Token('NNN', matchEraAbbr);
addRege***REMOVED***Token('NNNN', matchEraName);
addRege***REMOVED***Token('NNNNN', matchEraNarrow);

addParseToken(
    ['N', 'NN', 'NNN', 'NNNN', 'NNNNN'],
    function (input, array, config, token) {
        var era = config._locale.erasParse(input, token, config._strict);
        if (era) {
            getParsingFlags(config).era = era;
        } else {
            getParsingFlags(config).invalidEra = input;
        }
    }
);

addRege***REMOVED***Token('y', matchUnsigned);
addRege***REMOVED***Token('yy', matchUnsigned);
addRege***REMOVED***Token('yyy', matchUnsigned);
addRege***REMOVED***Token('yyyy', matchUnsigned);
addRege***REMOVED***Token('yo', matchEraYearOrdinal);

addParseToken(['y', 'yy', 'yyy', 'yyyy'], YEAR);
addParseToken(['yo'], function (input, array, config, token) {
    var match;
    if (config._locale._eraYearOrdinalRege***REMOVED***) {
        match = input.match(config._locale._eraYearOrdinalRege***REMOVED***);
    }

    if (config._locale.eraYearOrdinalParse) {
        array[YEAR] = config._locale.eraYearOrdinalParse(input, match);
    } else {
        array[YEAR] = parseInt(input, 10);
    }
});

e***REMOVED***port function localeEras(m, format) {
    var i,
        l,
        date,
        eras = this._eras || getLocale('en')._eras;
    for (i = 0, l = eras.length; i < l; ++i) {
        switch (typeof eras[i].since) {
            case 'string':
                // truncate time
                date = moment(eras[i].since).startOf('day');
                eras[i].since = date.valueOf();
                break;
        }

        switch (typeof eras[i].until) {
            case 'undefined':
                eras[i].until = +Infinity;
                break;
            case 'string':
                // truncate time
                date = moment(eras[i].until).startOf('day').valueOf();
                eras[i].until = date.valueOf();
                break;
        }
    }
    return eras;
}

e***REMOVED***port function localeErasParse(eraName, format, strict) {
    var i,
        l,
        eras = this.eras(),
        name,
        abbr,
        narrow;
    eraName = eraName.toUpperCase();

    for (i = 0, l = eras.length; i < l; ++i) {
        name = eras[i].name.toUpperCase();
        abbr = eras[i].abbr.toUpperCase();
        narrow = eras[i].narrow.toUpperCase();

        if (strict) {
            switch (format) {
                case 'N':
                case 'NN':
                case 'NNN':
                    if (abbr === eraName) {
                        return eras[i];
                    }
                    break;

                case 'NNNN':
                    if (name === eraName) {
                        return eras[i];
                    }
                    break;

                case 'NNNNN':
                    if (narrow === eraName) {
                        return eras[i];
                    }
                    break;
            }
        } else if ([name, abbr, narrow].inde***REMOVED***Of(eraName) >= 0) {
            return eras[i];
        }
    }
}

e***REMOVED***port function localeErasConvertYear(era, year) {
    var dir = era.since <= era.until ? +1 : -1;
    if (year === undefined) {
        return moment(era.since).year();
    } else {
        return moment(era.since).year() + (year - era.offset) * dir;
    }
}

e***REMOVED***port function getEraName() {
    var i,
        l,
        val,
        eras = this.localeData().eras();
    for (i = 0, l = eras.length; i < l; ++i) {
        // truncate time
        val = this.clone().startOf('day').valueOf();

        if (eras[i].since <= val && val <= eras[i].until) {
            return eras[i].name;
        }
        if (eras[i].until <= val && val <= eras[i].since) {
            return eras[i].name;
        }
    }

    return '';
}

e***REMOVED***port function getEraNarrow() {
    var i,
        l,
        val,
        eras = this.localeData().eras();
    for (i = 0, l = eras.length; i < l; ++i) {
        // truncate time
        val = this.clone().startOf('day').valueOf();

        if (eras[i].since <= val && val <= eras[i].until) {
            return eras[i].narrow;
        }
        if (eras[i].until <= val && val <= eras[i].since) {
            return eras[i].narrow;
        }
    }

    return '';
}

e***REMOVED***port function getEraAbbr() {
    var i,
        l,
        val,
        eras = this.localeData().eras();
    for (i = 0, l = eras.length; i < l; ++i) {
        // truncate time
        val = this.clone().startOf('day').valueOf();

        if (eras[i].since <= val && val <= eras[i].until) {
            return eras[i].abbr;
        }
        if (eras[i].until <= val && val <= eras[i].since) {
            return eras[i].abbr;
        }
    }

    return '';
}

e***REMOVED***port function getEraYear() {
    var i,
        l,
        dir,
        val,
        eras = this.localeData().eras();
    for (i = 0, l = eras.length; i < l; ++i) {
        dir = eras[i].since <= eras[i].until ? +1 : -1;

        // truncate time
        val = this.clone().startOf('day').valueOf();

        if (
            (eras[i].since <= val && val <= eras[i].until) ||
            (eras[i].until <= val && val <= eras[i].since)
        ) {
            return (
                (this.year() - moment(eras[i].since).year()) * dir +
                eras[i].offset
            );
        }
    }

    return this.year();
}

e***REMOVED***port function erasNameRege***REMOVED***(isStrict) {
    if (!hasOwnProp(this, '_erasNameRege***REMOVED***')) {
        computeErasParse.call(this);
    }
    return isStrict ? this._erasNameRege***REMOVED*** : this._erasRege***REMOVED***;
}

e***REMOVED***port function erasAbbrRege***REMOVED***(isStrict) {
    if (!hasOwnProp(this, '_erasAbbrRege***REMOVED***')) {
        computeErasParse.call(this);
    }
    return isStrict ? this._erasAbbrRege***REMOVED*** : this._erasRege***REMOVED***;
}

e***REMOVED***port function erasNarrowRege***REMOVED***(isStrict) {
    if (!hasOwnProp(this, '_erasNarrowRege***REMOVED***')) {
        computeErasParse.call(this);
    }
    return isStrict ? this._erasNarrowRege***REMOVED*** : this._erasRege***REMOVED***;
}

function matchEraAbbr(isStrict, locale) {
    return locale.erasAbbrRege***REMOVED***(isStrict);
}

function matchEraName(isStrict, locale) {
    return locale.erasNameRege***REMOVED***(isStrict);
}

function matchEraNarrow(isStrict, locale) {
    return locale.erasNarrowRege***REMOVED***(isStrict);
}

function matchEraYearOrdinal(isStrict, locale) {
    return locale._eraYearOrdinalRege***REMOVED*** || matchUnsigned;
}

function computeErasParse() {
    var abbrPieces = [],
        namePieces = [],
        narrowPieces = [],
        mi***REMOVED***edPieces = [],
        i,
        l,
        erasName,
        erasAbbr,
        erasNarrow,
        eras = this.eras();

    for (i = 0, l = eras.length; i < l; ++i) {
        erasName = rege***REMOVED***Escape(eras[i].name);
        erasAbbr = rege***REMOVED***Escape(eras[i].abbr);
        erasNarrow = rege***REMOVED***Escape(eras[i].narrow);

        namePieces.push(erasName);
        abbrPieces.push(erasAbbr);
        narrowPieces.push(erasNarrow);
        mi***REMOVED***edPieces.push(erasName);
        mi***REMOVED***edPieces.push(erasAbbr);
        mi***REMOVED***edPieces.push(erasNarrow);
    }

    this._erasRege***REMOVED*** = new RegE***REMOVED***p('^(' + mi***REMOVED***edPieces.join('|') + ')', 'i');
    this._erasNameRege***REMOVED*** = new RegE***REMOVED***p('^(' + namePieces.join('|') + ')', 'i');
    this._erasAbbrRege***REMOVED*** = new RegE***REMOVED***p('^(' + abbrPieces.join('|') + ')', 'i');
    this._erasNarrowRege***REMOVED*** = new RegE***REMOVED***p(
        '^(' + narrowPieces.join('|') + ')',
        'i'
    );
}
