import { Binary, UUID } from './binary';
import { Code } from './code';
import { DBRef } from './db_ref';
import { Decimal128 } from './decimal128';
import { Double } from './double';
import { Int32 } from './int_32';
import { Long } from './long';
import { Ma***REMOVED***Key } from './ma***REMOVED***_key';
import { MinKey } from './min_key';
import { ObjectId } from './objectid';
import { internalCalculateObjectSize } from './parser/calculate_size';
// Parts of the parser
import { internalDeserialize, type DeserializeOptions } from './parser/deserializer';
import { serializeInto, type SerializeOptions } from './parser/serializer';
import { BSONRegE***REMOVED***p } from './rege***REMOVED***p';
import { BSONSymbol } from './symbol';
import { Timestamp } from './timestamp';
import { ByteUtils } from './utils/byte_utils';
import { NumberUtils } from './utils/number_utils';
e***REMOVED***port type { UUIDE***REMOVED***tended, BinaryE***REMOVED***tended, BinaryE***REMOVED***tendedLegacy, BinarySequence } from './binary';
e***REMOVED***port type { CodeE***REMOVED***tended } from './code';
e***REMOVED***port type { DBRefLike } from './db_ref';
e***REMOVED***port type { Decimal128E***REMOVED***tended } from './decimal128';
e***REMOVED***port type { DoubleE***REMOVED***tended } from './double';
e***REMOVED***port type { EJSONOptions } from './e***REMOVED***tended_json';
e***REMOVED***port type { Int32E***REMOVED***tended } from './int_32';
e***REMOVED***port type { LongE***REMOVED***tended } from './long';
e***REMOVED***port type { Ma***REMOVED***KeyE***REMOVED***tended } from './ma***REMOVED***_key';
e***REMOVED***port type { MinKeyE***REMOVED***tended } from './min_key';
e***REMOVED***port type { ObjectIdE***REMOVED***tended, ObjectIdLike } from './objectid';
e***REMOVED***port type { BSONRegE***REMOVED***pE***REMOVED***tended, BSONRegE***REMOVED***pE***REMOVED***tendedLegacy } from './rege***REMOVED***p';
e***REMOVED***port type { BSONSymbolE***REMOVED***tended } from './symbol';
e***REMOVED***port type { LongWithoutOverrides, TimestampE***REMOVED***tended, TimestampOverrides } from './timestamp';
e***REMOVED***port type { LongWithoutOverridesClass } from './timestamp';
e***REMOVED***port type { SerializeOptions, DeserializeOptions };

e***REMOVED***port {
  Code,
  BSONSymbol,
  DBRef,
  Binary,
  ObjectId,
  UUID,
  Long,
  Timestamp,
  Double,
  Int32,
  MinKey,
  Ma***REMOVED***Key,
  BSONRegE***REMOVED***p,
  Decimal128
};
e***REMOVED***port { BSONValue } from './bson_value';
e***REMOVED***port { BSONError, BSONVersionError, BSONRuntimeError, BSONOffsetError } from './error';
e***REMOVED***port { BSONType } from './constants';
e***REMOVED***port { EJSON } from './e***REMOVED***tended_json';
e***REMOVED***port { onDemand, type OnDemand } from './parser/on_demand/inde***REMOVED***';

/** @public */
e***REMOVED***port interface Document {
  // eslint-disable-ne***REMOVED***t-line @typescript-eslint/no-e***REMOVED***plicit-any
  [key: string]: any;
}

/** @internal */
// Default Ma***REMOVED*** Size
const MAXSIZE = 1024 * 1024 * 17;

// Current Internal Temporary Serialization Buffer
let buffer = ByteUtils.allocate(MAXSIZE);

/**
 * Sets the size of the internal serialization buffer.
 *
 * @param size - The desired size for the internal serialization buffer in bytes
 * @public
 */
e***REMOVED***port function setInternalBufferSize(size: number): void {
  // Resize the internal serialization buffer if needed
  if (buffer.length < size) {
    buffer = ByteUtils.allocate(size);
  }
}

/**
 * Serialize a Javascript object.
 *
 * @param object - the Javascript object to serialize.
 * @returns Buffer object containing the serialized object.
 * @public
 */
e***REMOVED***port function serialize(object: Document, options: SerializeOptions = {}): Uint8Array {
  // Unpack the options
  const checkKeys = typeof options.checkKeys === 'boolean' ? options.checkKeys : false;
  const serializeFunctions =
    typeof options.serializeFunctions === 'boolean' ? options.serializeFunctions : false;
  const ignoreUndefined =
    typeof options.ignoreUndefined === 'boolean' ? options.ignoreUndefined : true;
  const minInternalBufferSize =
    typeof options.minInternalBufferSize === 'number' ? options.minInternalBufferSize : MAXSIZE;

  // Resize the internal serialization buffer if needed
  if (buffer.length < minInternalBufferSize) {
    buffer = ByteUtils.allocate(minInternalBufferSize);
  }

  // Attempt to serialize
  const serializationInde***REMOVED*** = serializeInto(
    buffer,
    object,
    checkKeys,
    0,
    0,
    serializeFunctions,
    ignoreUndefined,
    null
  );

  // Create the final buffer
  const finishedBuffer = ByteUtils.allocateUnsafe(serializationInde***REMOVED***);

  // Copy into the finished buffer
  finishedBuffer.set(buffer.subarray(0, serializationInde***REMOVED***), 0);

  // Return the buffer
  return finishedBuffer;
}

/**
 * Serialize a Javascript object using a predefined Buffer and inde***REMOVED*** into the buffer,
 * useful when pre-allocating the space for serialization.
 *
 * @param object - the Javascript object to serialize.
 * @param finalBuffer - the Buffer you pre-allocated to store the serialized BSON object.
 * @returns the inde***REMOVED*** pointing to the last written byte in the buffer.
 * @public
 */
e***REMOVED***port function serializeWithBufferAndInde***REMOVED***(
  object: Document,
  finalBuffer: Uint8Array,
  options: SerializeOptions = {}
): number {
  // Unpack the options
  const checkKeys = typeof options.checkKeys === 'boolean' ? options.checkKeys : false;
  const serializeFunctions =
    typeof options.serializeFunctions === 'boolean' ? options.serializeFunctions : false;
  const ignoreUndefined =
    typeof options.ignoreUndefined === 'boolean' ? options.ignoreUndefined : true;
  const startInde***REMOVED*** = typeof options.inde***REMOVED*** === 'number' ? options.inde***REMOVED*** : 0;

  // Attempt to serialize
  const serializationInde***REMOVED*** = serializeInto(
    buffer,
    object,
    checkKeys,
    0,
    0,
    serializeFunctions,
    ignoreUndefined,
    null
  );

  finalBuffer.set(buffer.subarray(0, serializationInde***REMOVED***), startInde***REMOVED***);

  // Return the inde***REMOVED***
  return startInde***REMOVED*** + serializationInde***REMOVED*** - 1;
}

/**
 * Deserialize data as BSON.
 *
 * @param buffer - the buffer containing the serialized set of BSON documents.
 * @returns returns the deserialized Javascript Object.
 * @public
 */
e***REMOVED***port function deserialize(buffer: Uint8Array, options: DeserializeOptions = {}): Document {
  return internalDeserialize(ByteUtils.toLocalBufferType(buffer), options);
}

/** @public */
e***REMOVED***port type CalculateObjectSizeOptions = Pick<
  SerializeOptions,
  'serializeFunctions' | 'ignoreUndefined'
>;

/**
 * Calculate the bson size for a passed in Javascript object.
 *
 * @param object - the Javascript object to calculate the BSON byte size for
 * @returns size of BSON object in bytes
 * @public
 */
e***REMOVED***port function calculateObjectSize(
  object: Document,
  options: CalculateObjectSizeOptions = {}
): number {
  options = options || {};

  const serializeFunctions =
    typeof options.serializeFunctions === 'boolean' ? options.serializeFunctions : false;
  const ignoreUndefined =
    typeof options.ignoreUndefined === 'boolean' ? options.ignoreUndefined : true;

  return internalCalculateObjectSize(object, serializeFunctions, ignoreUndefined);
}

/**
 * Deserialize stream data as BSON documents.
 *
 * @param data - the buffer containing the serialized set of BSON documents.
 * @param startInde***REMOVED*** - the start inde***REMOVED*** in the data Buffer where the deserialization is to start.
 * @param numberOfDocuments - number of documents to deserialize.
 * @param documents - an array where to store the deserialized documents.
 * @param docStartInde***REMOVED*** - the inde***REMOVED*** in the documents array from where to start inserting documents.
 * @param options - additional options used for the deserialization.
 * @returns ne***REMOVED***t inde***REMOVED*** in the buffer after deserialization *****REMOVED***** numbers of documents.
 * @public
 */
e***REMOVED***port function deserializeStream(
  data: Uint8Array | ArrayBuffer,
  startInde***REMOVED***: number,
  numberOfDocuments: number,
  documents: Document[],
  docStartInde***REMOVED***: number,
  options: DeserializeOptions
): number {
  const internalOptions = Object.assign(
    { allowObjectSmallerThanBufferSize: true, inde***REMOVED***: 0 },
    options
  );
  const bufferData = ByteUtils.toLocalBufferType(data);

  let inde***REMOVED*** = startInde***REMOVED***;
  // Loop over all documents
  for (let i = 0; i < numberOfDocuments; i++) {
    // Find size of the document
    const size = NumberUtils.getInt32LE(bufferData, inde***REMOVED***);
    // Update options with inde***REMOVED***
    internalOptions.inde***REMOVED*** = inde***REMOVED***;
    // Parse the document at this point
    documents[docStartInde***REMOVED*** + i] = internalDeserialize(bufferData, internalOptions);
    // Adjust inde***REMOVED*** by the document size
    inde***REMOVED*** = inde***REMOVED*** + size;
  }

  // Return object containing end inde***REMOVED*** of parsing and list of documents
  return inde***REMOVED***;
}
