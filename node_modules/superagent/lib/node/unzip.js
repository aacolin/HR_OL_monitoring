"use strict";

/**
 * Module dependencies.
 */
var _require = require('string_decoder'),
    StringDecoder = _require.StringDecoder;

var Stream = require('stream');

var zlib = require('zlib');
/**
 * Buffers response data events and re-emits when they're unzipped.
 *
 * @param {Request} req
 * @param {Response} res
 * @api private
 */


e***REMOVED***ports.unzip = function (req, res) {
  var unzip = zlib.createUnzip();
  var stream = new Stream();
  var decoder; // make node responseOnEnd() happy

  stream.req = req;
  unzip.on('error', function (err) {
    if (err && err.code === 'Z_BUF_ERROR') {
      // une***REMOVED***pected end of file is ignored by browsers and curl
      stream.emit('end');
      return;
    }

    stream.emit('error', err);
  }); // pipe to unzip

  res.pipe(unzip); // override `setEncoding` to capture encoding

  res.setEncoding = function (type) {
    decoder = new StringDecoder(type);
  }; // decode upon decompressing with captured encoding


  unzip.on('data', function (buf) {
    if (decoder) {
      var str = decoder.write(buf);
      if (str.length > 0) stream.emit('data', str);
    } else {
      stream.emit('data', buf);
    }
  });
  unzip.on('end', function () {
    stream.emit('end');
  }); // override `on` to capture data listeners

  var _on = res.on;

  res.on = function (type, fn) {
    if (type === 'data' || type === 'end') {
      stream.on(type, fn.bind(res));
    } else if (type === 'error') {
      stream.on(type, fn.bind(res));

      _on.call(res, type, fn);
    } else {
      _on.call(res, type, fn);
    }

    return this;
  };
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ub2RlL3VuemlwLmpzIl0sIm5hbWVzIjpbInJlcXVpcmUiLCJTdHJpbmdEZWNvZGVyIiwiU3RyZWFtIiwiem***REMOVED***pYiIsImV4cG9ydHMiLCJ1bnppcCIsInJlcSIsInJlcyIsImNyZWF0ZVVuemlwIiwic3RyZWFtIiwiZGVjb2RlciIsIm9uIiwiZXJyIiwiY29kZSIsImVtaXQiLCJwaXBlIiwic2V0RW5jb2RpbmciLCJ0eXBlIiwiYnVmIiwic3RyIiwid3JpdGUiLCJsZW5ndGgiLCJfb24iLCJmbiIsImJpbmQiLCJjYW***REMOVED***sIl0sIm1hcHBpbmdzIjoiOztBQUFBOzs7ZUFJMEJBLE9BQU8sQ0FBQy***REMOVED***nQkFBRC***REMOVED***DO0lBQXpCQy***REMOVED***hLFlBQUFBLGE7O0FBQ1IsSUFBTUMsTUFBTS***REMOVED***HQUFHRi***REMOVED***PQUFPLENBQUMsUUFBRC***REMOVED***DQUF0Qjs7QUFDQS***REMOVED***JQUFNRy***REMOVED***JQUFJLEdBQUdILE9BQU8sQ0FBQy***REMOVED***NQUFELENBQXBCO0FBRUE7Ozs7Ozs7OztBQVFBSS***REMOVED***PQUFPLENBQUNDLEtBQVIsR0FBZ0IsVUFBQ0MsR0FBRC***REMOVED***FQUFNQy***REMOVED***HQUFOLEVBQWM7QUFDNUIsTUFBTUYsS0FBSy***REMOVED***HQUFHRi***REMOVED***JQUFJLENBQUNLLFdBQUwsRUFBZDtBQUNBLE1BQU1DLE1BQU0sR0FBRy***REMOVED***JQUFJUC***REMOVED***NQUFKLEVBQWY7QUFDQS***REMOVED***NQUFJUS***REMOVED***PQUFKLENBSDRCLENBSzVCOztBQUNBRC***REMOVED***FQUFBQS***REMOVED***NQUFNLENBQUNILEdBQVAsR0FBYUEsR0FBYjtBQUVBRC***REMOVED***FQUFBQS***REMOVED***LQUFLLENBQUNNLEVBQU4sQ0FBUy***REMOVED***PQUFULEVBQWtCLFVBQUFDLEdBQUcsRUFBSTtBQUN2Qi***REMOVED***RQUFJQS***REMOVED***HQUFHLElBQUlBLEdBQUcsQ0FBQ0MsSUFBSi***REMOVED***LQUFhLGFBQXhCLEVBQXVDO0FBQ3JDO0FBQ0FKLE1BQUFBLE1BQU0sQ0FBQ0ssSUFBUC***REMOVED***DQUFZLEtBQVo7QUFDQTtBQUNEOztBQUVETC***REMOVED***JQUFBQS***REMOVED***NQUFNLENBQUNLLElBQVAsQ0FBWS***REMOVED***PQUFaLEVBQXFCRi***REMOVED***HQUFyQjtBQUNELEdBUkQsRUFSNEIsQ0FrQjVCOztBQUNBTC***REMOVED***FQUFBQS***REMOVED***HQUFHLENBQUNRLElBQUosQ0FBU1YsS0FBVC***REMOVED***FQW5CNEIsQ0F***REMOVED***QjVCOztBQUNBRS***REMOVED***FQUFBQS***REMOVED***HQUFHLENBQUNTLFdBQUosR0FBa0IsVUFBQUMsSUFBSS***REMOVED***FQUFJO0FBQ3hCUC***REMOVED***JQUFBQS***REMOVED***PQUFPLEdBQUcsSUFBSVQsYUFBSi***REMOVED***DQUFrQmdCLElBQW***REMOVED***CLENBQVY7QUFDRC***REMOVED***HQUZELENBdEI0Qi***REMOVED***DQTBCNUI7OztBQUNBWi***REMOVED***FQUFBQS***REMOVED***LQUFLLENBQUNNLEVBQU4sQ0FBUy***REMOVED***NQUFULEVBQWlCLFVBQUFPLEdBQUcsRUFBSTtBQUN0Qi***REMOVED***RQUFJUi***REMOVED***PQUFKLEVBQWE7QUFDWC***REMOVED***VQUFNUy***REMOVED***HQUFHLEdBQUdULE9BQU8sQ0FBQ1UsS0FBUi***REMOVED***DQUFjRi***REMOVED***HQUFkLENBQVo7QUFDQS***REMOVED***VQUFJQy***REMOVED***HQUFHLENBQUNFLE1BQUosR0FBYS***REMOVED***DQUFqQi***REMOVED***FQUFvQlosTUFBTS***REMOVED***DQUFDSy***REMOVED***JQUFQLENBQVksTUFBWi***REMOVED***FQUFvQkssR0FBcEI7QUFDckIsS0FIRC***REMOVED***NQUdPO0FBQ0***REMOVED***WLE1BQUFBLE1BQU0sQ0FBQ0ssSUFBUC***REMOVED***DQUFZLE1BQVosRUFBb0JJLEdBQXBCO0FBQ0Q7QUFDRi***REMOVED***HQVBEO0FBU0FiLEVBQUFBLEtBQUssQ0FBQ00sRUFBTi***REMOVED***DQUFTLEtBQVQsRUFBZ0IsWUFBTTtBQUNwQkYsSUFBQUEsTUFBTS***REMOVED***DQUFDSy***REMOVED***JQUFQLENBQVksS0FBWjtBQUNELEdBRkQsRUFwQzRCLENBd0M1Qjs7QUFDQS***REMOVED***NQUFNUS***REMOVED***HQUFHLEdBQUdmLEdBQUcsQ0FBQ0ksRUFBaEI7O0FBQ0FKLEVBQUFBLEdBQUcsQ0FBQ0ksRUFBSi***REMOVED***HQUFTLFVBQVNNLElBQVQsRUFBZU0sRUFBZi***REMOVED***FQUFtQjtBQUM***REMOVED***Qi***REMOVED***RQUFJTi***REMOVED***JQUFJLEtBQUssTUFBVC***REMOVED***JQUFtQkEsSUFBSS***REMOVED***LQUFLLEtBQWhDLEVBQXVDO0FBQ3JDUi***REMOVED***NQUFBQS***REMOVED***NQUFNLENBQUNFLEVBQVAsQ0FBVU0sSUFBVi***REMOVED***FQUFnQk0sRUFBRS***REMOVED***DQUFDQy***REMOVED***JQUFILENBQVFqQi***REMOVED***HQUFSLENBQWhCO0FBQ0QsS0FGRC***REMOVED***NQUVPLElBQUlVLElBQUksS0FBSy***REMOVED***PQUFiLEVBQXNCO0FBQzNCUi***REMOVED***NQUFBQS***REMOVED***NQUFNLENBQUNFLEVBQVAsQ0FBVU0sSUFBVi***REMOVED***FQUFnQk0sRUFBRS***REMOVED***DQUFDQy***REMOVED***JQUFILENBQVFqQi***REMOVED***HQUFSLENBQWhCOztBQUNBZS***REMOVED***NQUFBQS***REMOVED***HQUFHLENBQUNHLElBQUosQ0FBU2***REMOVED***CLEdBQVQsRUFBY1UsSUFBZC***REMOVED***FQUFvQk0sRUFBcEI7QUFDRC***REMOVED***LQUhNLE1BR0E7QUFDTEQsTUFBQUEsR0FBRy***REMOVED***DQUFDRy***REMOVED***JQUFKLENBQVNsQi***REMOVED***HQUFULEVBQWNVLElBQWQsRUFBb0JNLEVBQXBCO0FBQ0Q7O0FBRUQsV0FBTy***REMOVED***JQUFQO0FBQ0QsR0FYRDtBQVlELENBdEREIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBNb2R1bGUgZGVwZW5kZW5jaWVzLl***REMOVED***uICovXG5cbmNvbnN0IHsgU3RyaW5nRGVjb2RlciB9ID0gcmV***REMOVED***dWlyZSgnc3RyaW5nX2RlY29kZXInKTtcbmNvbnN0IFN0cmVhbSA9IHJlcXVpcmUoJ3N0cmVhbScpO1***REMOVED***uY29uc3Qgem***REMOVED***pYiA9IHJlcXVpcmUoJ3psaWInKTtcbl***REMOVED***uLyoqXG4gKiBCdWZmZXJzIHJlc3BvbnNlIGRhdGEgZXZlbnRzIGFuZCByZS1lbWl0cyB3aGVuIHRoZXkncmUgdW56aXBwZWQuXG4gKl***REMOVED***uICogQHBhcmFtIHtSZXF1ZXN0fSByZXFcbiAqIEBwYXJhbSB7UmVzcG9uc2V9IHJlc1***REMOVED***uICogQGFwaSBwcml2YXRlXG4gKi9cbl***REMOVED***uZXhwb3J0cy51bnppcCA9IChyZXEsIHJlcykgPT4ge1***REMOVED***uICBjb25zdCB1bnppcCA9IHpsaWIuY3JlYXRlVW56aXAoKTtcbiAgY29uc3Qgc3RyZWFtID0gbmV3IFN0cmVhbSgpO1***REMOVED***uICBsZXQgZGVjb2Rlcjtcbl***REMOVED***uICAvLyBtYWtlIG5vZGUgcmVzcG9uc2VPbkVuZCgpIGhhcHB5XG4gIHN0cmVhbS5yZXEgPSByZXE7XG5cbiAgdW56aXAub24oJ2Vycm9yJywgZXJyID0+IHtcbiAgICBpZiAoZXJyICYmIGVyci5jb2RlID09PSAnWl9CVUZfRVJST1InKSB7XG4gICAgICAvLyB1bmV4cGVjdGVkIGVuZCBvZiBmaW***REMOVED***lIGlzIGlnbm9yZWQgYnkgYnJvd3NlcnMgYW5kIGN1cm***REMOVED***cbiAgICAgIHN0cmVhbS5lbWl0KCdlbmQnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBzdHJlYW0uZW1pdCgnZXJyb3InLCBlcnIpO1***REMOVED***uICB9KTtcbl***REMOVED***uICAvLyBwaXBlIHRvIHVuemlwXG4gIHJlcy5waXBlKHVuemlwKTtcbl***REMOVED***uICAvLyBvdmVycmlkZSBgc2V0RW5jb2RpbmdgIHRvIGNhcHR1cmUgZW5jb2RpbmdcbiAgcmVzLnNldEVuY29kaW5nID0gdHlwZSA9PiB7XG4gICAgZGVjb2RlciA9IG5ldyBTdHJpbmdEZWNvZGVyKHR5cGUpO1***REMOVED***uICB9O1***REMOVED***uXG4gIC8vIGRlY29kZSB1cG9uIGRlY29tcHJlc3Npbmcgd2l0aCBjYXB0dXJlZCBlbmNvZGluZ1***REMOVED***uICB1bnppcC5vbignZGF0YScsIGJ1ZiA9PiB7XG4gICAgaWYgKGRlY29kZXIpIHtcbiAgICAgIGNvbnN0IHN0ciA9IGRlY29kZXIud3JpdGUoYnVmKTtcbiAgICAgIGlmIChzdHIubGVuZ3RoID4gMCkgc3RyZWFtLmVtaXQoJ2RhdGEnLCBzdHIpO1***REMOVED***uICAgIH0gZW***REMOVED***zZSB7XG4gICAgICBzdHJlYW0uZW1pdCgnZGF0YScsIGJ1Zik7XG4gICAgfV***REMOVED***uICB9KTtcbl***REMOVED***uICB1bnppcC5vbignZW5kJywgKCkgPT4ge1***REMOVED***uICAgIHN0cmVhbS5lbWl0KCdlbmQnKTtcbiAgfSk7XG5cbiAgLy8gb3ZlcnJpZGUgYG9uYCB0byBjYXB0dXJlIGRhdGEgbGlzdGVuZXJzXG4gIGNvbnN0IF9vbiA9IHJlcy5vbjtcbiAgcmVzLm9uID0gZnVuY3Rpb24odHlwZSwgZm4pIHtcbiAgICBpZiAodHlwZSA9PT0gJ2RhdGEnIH***REMOVED***8IHR5cGUgPT09ICdlbmQnKSB7XG4gICAgICBzdHJlYW0ub24odHlwZSwgZm4uYmluZChyZXMpKTtcbiAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdlcnJvcicpIHtcbiAgICAgIHN0cmVhbS5vbih0eXBlLCBmbi5iaW5kKHJlcykpO1***REMOVED***uICAgICAgX29uLmNhbGwocmVzLCB0eXBlLCBmbik7XG4gICAgfSBlbHNlIHtcbiAgICAgIF9vbi5jYW***REMOVED***sKHJlcywgdHlwZSwgZm4pO1***REMOVED***uICAgIH1cbl***REMOVED***uICAgIHJldHVybiB0aGlzO1***REMOVED***uICB9O1***REMOVED***ufTtcbiJdfQ==